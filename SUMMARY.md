# HAPT3Dï¼šçœŸå®æœå›­ç¯å¢ƒä¸­è·¨ä¸åŒä¼ æ„Ÿå™¨çš„3Då±‚æ¬¡åŒ–å…¨æ™¯åˆ†å‰²

> **è®ºæ–‡ + ä»£ç å®ç°æ·±åº¦è§£æ**

---

## ğŸ“„ è®ºæ–‡ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ ‡é¢˜** | 3D Hierarchical Panoptic Segmentation in Real Orchard Environments Across Different Sensors |
| **ä½œè€…** | Matteo Sodano, Federico Magistri, Elias Marks ç­‰ |
| **å•ä½** | å¾·å›½æ³¢æ©å¤§å­¦æœºå™¨äººä¸­å¿ƒ |
| **ä¼šè®®** | IROS 2025 |
| **ä»£ç ** | https://github.com/PRBonn/hapt3D |
| **æ•°æ®é›†** | https://www.ipb.uni-bonn.de/data/hops/ |

---

## ğŸ¯ ç ”ç©¶åŠ¨æœºä¸é—®é¢˜å®šä¹‰

### èƒŒæ™¯éœ€æ±‚
- **ä½œç‰©äº§é‡ä¼°è®¡**æ˜¯ç²¾å‡†å†œä¸šçš„æ ¸å¿ƒä»»åŠ¡
- å‡†ç¡®ä¼°è®¡å¯ä¼˜åŒ–æ”¶è·æ—¶é—´ã€æ–½è‚¥é‡ç­‰å…³é”®å†³ç­–
- æœºå™¨äººè‡ªåŠ¨åŒ–é‡‡æ‘˜éœ€è¦ç²¾ç¡®çš„ç¯å¢ƒæ„ŸçŸ¥èƒ½åŠ›

### ç°æœ‰é—®é¢˜
1. å†œä¸šé¢†åŸŸçš„**3Dæ•°æ®é›†ç¨€ç¼º**
2. ç°æœ‰æ–¹æ³•**æ— æ³•åŒæ—¶å¤„ç†å¤šçº§å®ä¾‹åˆ†å‰²**ä»»åŠ¡
3. ç¼ºä¹ä¸“é—¨é’ˆå¯¹**å±‚æ¬¡åŒ–å…¨æ™¯åˆ†å‰²**çš„æ–¹æ³•

### ä»»åŠ¡å®šä¹‰ï¼šå±‚æ¬¡åŒ–å…¨æ™¯åˆ†å‰²
åŒæ—¶æ‰§è¡Œä¸‰ä¸ªç›¸äº’å…³è”çš„åˆ†å‰²ä»»åŠ¡ï¼š

| ä»»åŠ¡å±‚çº§ | ä»»åŠ¡åç§° | è¾“å‡ºå†…å®¹ | åº”ç”¨ä»·å€¼ |
|----------|----------|----------|----------|
| **Level 1** | è¯­ä¹‰åˆ†å‰² | æ¯ä¸ªç‚¹çš„ç±»åˆ«æ ‡ç­¾ï¼ˆ6ç±»ï¼‰ | åœºæ™¯ç†è§£ |
| **Level 2** | æ ‘æœ¨å®ä¾‹åˆ†å‰² | æ¯æ£µæ ‘ï¼ˆæ ‘å¹²+æœå®ï¼‰çš„å®ä¾‹ID | å•æ ªäº§é‡ç»Ÿè®¡ |
| **Level 3** | æ ‡å‡†å®ä¾‹åˆ†å‰² | æ¯ä¸ªæœå®/æ ‘å¹²çš„å®ä¾‹ID | æœå®è®¡æ•°ã€é‡‡æ‘˜å®šä½ |

---

## ğŸ”¬ æ ¸å¿ƒè´¡çŒ®

### è´¡çŒ®1ï¼šå±‚æ¬¡åŒ–å…¨æ™¯åˆ†å‰²ç½‘ç»œ
- åŸºäº **MinkUNet14A** çš„ä¸‰è§£ç å™¨æ¶æ„
- åˆ›æ–°çš„**è§£ç å™¨é—´è·³è·ƒè¿æ¥**æ–¹æ¡ˆ
- å•æ¬¡è®­ç»ƒåŒæ—¶å®Œæˆä¸‰ä¸ªåˆ†å‰²ä»»åŠ¡

### è´¡çŒ®2ï¼šHOPSæ•°æ®é›†
- **H**ierarchical **O**rchard **P**anoptic **S**egmentation
- çœŸå®è‹¹æœå›­çš„3Dç‚¹äº‘æ•°æ®
- å¤šä¼ æ„Ÿå™¨é‡‡é›†ï¼ˆTLSã€UAVã€UGVã€SfMï¼‰
- ä¸“é—¨è®¾è®¡çš„**åŸŸåç§»**æµ‹è¯•åŸºå‡†

---

## ğŸ“Š HOPSæ•°æ®é›†è¯¦è§£

### ä¼ æ„Ÿå™¨é…ç½®

| ä¼ æ„Ÿå™¨ | è®¾å¤‡ | ç‰¹ç‚¹ | æ•°æ®ç”¨é€” |
|--------|------|------|----------|
| **TLS** | Leicaåœ°é¢æ¿€å…‰æ‰«æä»ª | é«˜ç²¾åº¦ã€é«˜å¯†åº¦ | è®­ç»ƒ/éªŒè¯/æµ‹è¯• |
| **UAV** | PhaseOne iXM-100 + æ— äººæœº | 45Â°/90Â°/135Â°è§’åº¦ï¼Œ~20mé«˜åº¦ | æµ‹è¯• |
| **UGV** | RealSense d435i + åœ°é¢æœºå™¨äºº | æ¶ˆè´¹çº§RGB-D | æµ‹è¯• |
| **SfM** | Canon EOS 60D (Fuji-SfM) | è¥¿ç­ç‰™ä¸åŒåœ°ç‚¹ | æµ‹è¯• |

### æ•°æ®é›†åˆ’åˆ†ä¸ç»Ÿè®¡

| æŒ‡æ ‡ | è®­ç»ƒé›†(TLS) | éªŒè¯é›†(TLS) | æµ‹è¯•-UGV | æµ‹è¯•-UAV | æµ‹è¯•-SfM | æµ‹è¯•-TLS |
|------|-------------|-------------|----------|----------|----------|----------|
| **æ ·æœ¬æ•°** | 90 | 18 | 12 | 22 | 6 | 27 |
| **å¹³å‡ç‚¹æ•°** | 0.8M | 1.0M | 0.6M | 1.5M | 1.8M | 1.0M |
| **å¹³å‡æœå®æ•°** | 90.2 | 99.2 | 71.8 | 99.1 | 232.3 | 39.9 |
| **å¹³å‡æ ‘å¹²æ•°** | 3.1 | 3.2 | 2.9 | 1.9 | 2.7 | 2.9 |
| **æ¯æ ‘æœå®æ•°** | 19.2 | 19.3 | 17.8 | 31.7 | 62.1 | 9.8 |

### è¯­ä¹‰ç±»åˆ«å®šä¹‰ï¼ˆä»£ç å®ç°ï¼‰

```python
# æ¥è‡ª models/hapt3d.py å’Œ utils/evaluation.py
STUFF_IDS = [1, 2, 5]   # èƒŒæ™¯ç±»ï¼šground, plant, pole
THINGS_IDS = [3, 4]     # å‰æ™¯ç±»ï¼šfruit, trunk

# è¯­ä¹‰ç±»åˆ«æ˜ å°„
# 0: void (å¿½ç•¥)
# 1: ground (åœ°é¢)
# 2: plant/canopy (æ¤ç‰©/æ ‘å† )
# 3: fruit (æœå®) - Things
# 4: trunk (æ ‘å¹²) - Things  
# 5: pole (æ†æŸ±)
```

| ID | ç±»åˆ« | è‹±æ–‡ | ç±»å‹ | å¯è§†åŒ–é¢œè‰² |
|----|------|------|------|------------|
| 0 | ç©º/å¿½ç•¥ | void | - | black |
| 1 | åœ°é¢ | ground | Stuff | tan |
| 2 | æ¤ç‰© | plant/canopy | Stuff | seagreen |
| 3 | æœå® | fruit | Things | orangered |
| 4 | æ ‘å¹² | trunk | Things | saddlebrown |
| 5 | æ†æŸ± | pole | Stuff | slategray |

### å±‚æ¬¡åŒ–æ ‡ç­¾ç»“æ„

```
æ ‡å‡†æ ‡ç­¾:
â”œâ”€â”€ semantic: [0-5] è¯­ä¹‰ç±»åˆ«
â””â”€â”€ instance: æ¯ä¸ªæœå®/æ ‘å¹²çš„å”¯ä¸€ID

å±‚æ¬¡æ ‡ç­¾:
â”œâ”€â”€ semantic_h: [0-1] (0=èƒŒæ™¯, 1=æ ‘)
â””â”€â”€ instance_h: æ¯æ£µæ ‘çš„å”¯ä¸€ID (æ ‘å¹²+å…¶æœå®å…±äº«åŒä¸€ID)
```

### æ•°æ®é›†è®¾è®¡äº®ç‚¹
âš ï¸ **æ•…æ„è®¾è®¡çš„åŸŸåç§»**ï¼š
- è®­ç»ƒé›†ï¼šä»…TLSé«˜è´¨é‡ç‚¹äº‘
- æµ‹è¯•é›†ï¼šå¤šç§ä¼ æ„Ÿå™¨ï¼ˆä¸åŒè®¾å¤‡ã€ä¸åŒå¹´ä»½ã€ä¸åŒåœ°ç‚¹ï¼‰
- ç›®çš„ï¼šæ¨åŠ¨æ„å»º**æ³›åŒ–èƒ½åŠ›å¼º**çš„æ¨¡å‹

---

## ğŸ—ï¸ ç½‘ç»œæ¶æ„è¯¦è§£

### æ•´ä½“æ¶æ„å›¾

```
                          è¾“å…¥: ç‚¹äº‘ (NÃ—3åæ ‡ + NÃ—3é¢œè‰²)
                                    â”‚
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   ä½“ç´ åŒ– (3mm)    â”‚  â† voxel_resolution=0.003
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                    å…±äº«ç¼–ç å™¨                          â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚ Block1 â”‚ â†’ â”‚ Block2 â”‚ â†’ â”‚ Block3 â”‚ â†’ â”‚ Block4 â”‚  â”‚
            â”‚  â”‚stride=2â”‚   â”‚stride=2â”‚   â”‚stride=2â”‚   â”‚stride=2â”‚  â”‚
            â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚
            â”‚      â”‚            â”‚            â”‚            â”‚        â”‚
            â”‚   out_b1p2    out_b2p4     out_b3p8    out_encoder   â”‚
            â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚            â”‚            â”‚            â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚            â”‚            â”‚            â”‚            â”‚        â”‚
      â”‚            â–¼            â–¼            â–¼            â–¼        â”‚
      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚  â”‚              è§£ç å™¨1: è¯­ä¹‰åˆ†å‰²                       â”‚   â”‚
      â”‚  â”‚  ç¼–ç å™¨è·³è·ƒ â†’ [Block5â†’Block6â†’Block7â†’Block8] â†’ 6ç±»   â”‚   â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                           â”‚ out_skip_sem (4ä¸ªå±‚çº§)          â”‚
      â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
      â”‚            â”‚              â”‚              â”‚                  â”‚
      â”‚            â–¼              â–¼              â–¼                  â”‚
      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚  â”‚              è§£ç å™¨2: æ ‘æœ¨å®ä¾‹åˆ†å‰² (ins2)             â”‚   â”‚
      â”‚  â”‚  ç¼–ç å™¨è·³è·ƒ+è¯­ä¹‰è·³è·ƒ â†’ [Block5â†’...â†’Block8] â†’ 3Dåç§»  â”‚   â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                           â”‚ out_skip_ins (4ä¸ªå±‚çº§)          â”‚
      â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
      â”‚            â”‚              â”‚              â”‚                  â”‚
      â”‚            â–¼              â–¼              â–¼                  â”‚
      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
      â”‚  â”‚              è§£ç å™¨3: æ ‡å‡†å®ä¾‹åˆ†å‰² (ins1)             â”‚   â”‚
      â”‚  â”‚  ç¼–ç å™¨è·³è·ƒ+ins2è·³è·ƒ â†’ [Block5â†’...â†’Block8] â†’ 3Dåç§»  â”‚   â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚                                                            â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
                    â–¼               â–¼               â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚è¯­ä¹‰é¢„æµ‹   â”‚   â”‚æ ‘å®ä¾‹åç§»â”‚   â”‚æ ‡å‡†å®ä¾‹åç§»â”‚
              â”‚ (NÃ—6)    â”‚   â”‚ (NÃ—3)    â”‚   â”‚ (NÃ—3)     â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚              â”‚              â”‚
                   â”‚              â–¼              â–¼
                   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚         â”‚   HDBSCAN èšç±»      â”‚
                   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                  â”‚
                   â–¼                  â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚è¯­ä¹‰åˆ†å‰²   â”‚   â”‚ å®ä¾‹åˆ†å‰²ç»“æœ      â”‚
              â”‚ ç»“æœ      â”‚   â”‚(æ ‘æœ¨/æœå®/æ ‘å¹²)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåˆ›æ–°ï¼šå±‚æ¬¡åŒ–è·³è·ƒè¿æ¥

**ä¼ ç»ŸUNet**ï¼šä»…ç¼–ç å™¨â†’è§£ç å™¨çš„è·³è·ƒè¿æ¥

**æœ¬æ–‡åˆ›æ–°**ï¼šè§£ç å™¨â†’è§£ç å™¨çš„çº§è”è·³è·ƒè¿æ¥

```python
# æ¥è‡ª models/minkunet_full.py çš„å…³é”®å®ç°

# è¯­ä¹‰è§£ç å™¨ - æ ‡å‡†è·³è·ƒè¿æ¥
out_sem = ME.cat(out_skip_sem1, out_b3p8)       # ç¼–ç å™¨ç‰¹å¾

# æ ‘æœ¨å®ä¾‹è§£ç å™¨ (ins2) - ç¼–ç å™¨ + è¯­ä¹‰è§£ç å™¨
out_ins2 = ME.cat(out_skip_ins1, out_b3p8, out_skip_sem1)  # ä¸‰è·¯æ‹¼æ¥

# æ ‡å‡†å®ä¾‹è§£ç å™¨ (ins1) - ç¼–ç å™¨ + æ ‘æœ¨å®ä¾‹è§£ç å™¨
out_ins1 = ME.cat(out_ins1, out_b3p8, out_skip_ins1)       # ä¸‰è·¯æ‹¼æ¥
```

### è·³è·ƒè¿æ¥å¯¹æ¯”ï¼ˆæ¶ˆèå®éªŒï¼‰

| æ–¹æ¡ˆ | è·³è·ƒè¿æ¥é…ç½® | mIoU | PQ | PQ_T | mPQ |
|------|-------------|------|-----|------|------|
| A | æ— è·³è·ƒè¿æ¥ | 55.8 | 42.8 | 47.7 | 45.3 |
| B | ä»…è§£ç å™¨â†’è§£ç å™¨ | 64.4 | 53.4 | 51.3 | 52.4 |
| C | ä»…ç¼–ç å™¨â†’è§£ç å™¨ | 69.8 | 58.8 | 50.9 | 54.9 |
| **D** | **ç¼–ç å™¨+è§£ç å™¨ï¼ˆæœ¬æ–‡ï¼‰** | **70.9** | **60.8** | **52.1** | **56.5** |

### ç½‘ç»œå‚æ•°ï¼ˆä»£ç é…ç½®ï¼‰

```yaml
# æ¥è‡ª config/config_full.yaml
network:
  tanh: True           # å¯¹åç§»è¾“å‡ºä½¿ç”¨tanhæ¿€æ´»ï¼Œå½’ä¸€åŒ–åˆ°[-1,1]
  skip: "full"         # å®Œæ•´è·³è·ƒè¿æ¥æ–¹æ¡ˆï¼ˆè®ºæ–‡æ–¹æ³•ï¼‰
  name: "MinkUNet14A"  # è½»é‡çº§ç½‘ç»œå˜ä½“

# ç½‘ç»œè§„æ ¼
# å‚æ•°é‡: 19.4M
# æ¯å±‚ç‰¹å¾é€šé“: [32, 32, 64, 128, 256, 128, 96, 96]
```

---

## ğŸ“‰ æŸå¤±å‡½æ•°è¯¦è§£

### æ€»æŸå¤±å‡½æ•°

$$\mathcal{L} = \mathcal{L}_{\text{sem}} + \mathcal{L}_{\text{ins1}} + \mathcal{L}_{\text{ins2}}$$

æ‰€æœ‰æŸå¤±æƒé‡å‡ä¸º1ï¼ˆ$w_1 = w_2 = w_3 = 1$ï¼‰

### 1. è¯­ä¹‰åˆ†å‰²æŸå¤±ï¼ˆCrossEntropyLossï¼‰

```python
# æ¥è‡ª models/hapt3d.py
self.ce = nn.CrossEntropyLoss(ignore_index=0)  # å¿½ç•¥voidç±»åˆ«

# è®¡ç®—
sem_loss = self.ce(soutput.F, sem_labels.long())
```

æ•°å­¦å½¢å¼ï¼š
$$\mathcal{L}_{\text{sem}} = -\frac{1}{|\mathcal{S}|} \sum_{\mathbf{p} \in \mathcal{S}} \mathbf{t}_p^\top \log(\sigma(\mathbf{f}_p))$$

### 2. å®ä¾‹åˆ†å‰²æŸå¤±ï¼ˆIoU LovÃ¡sz Lossï¼‰

```python
# æ¥è‡ª utils/lovasz.py
class IoULovaszLoss:
    """
    åŸºäºLovÃ¡szæ‰©å±•çš„IoUæŸå¤±
    
    åŸç†:
    1. æ¯ä¸ªç‚¹é¢„æµ‹åç§»å‘é‡ o_p
    2. é¢„æµ‹ä¸­å¿ƒ = ç‚¹åæ ‡ + åç§»å‘é‡
    3. è®¡ç®—è½¯æ©ç ï¼ˆåŸºäºåˆ°å®ä¾‹è´¨å¿ƒçš„è·ç¦»ï¼‰
    4. åº”ç”¨LovÃ¡szæ¢¯åº¦ä¼˜åŒ–IoU
    """
    
    def __call__(self, offsets, coords, instance_labels, ...):
        # è®¡ç®—é¢„æµ‹çš„å®ä¾‹ä¸­å¿ƒ
        centers = coords + offsets  # e_p = p + o_p
        
        # å¯¹æ¯ä¸ªå®ä¾‹è®¡ç®—LovÃ¡szæŸå¤±
        for inst_id in unique_instances:
            mask = (instance_labels == inst_id)
            centroid = centers[mask].mean(dim=0)
            
            # è½¯æ©ç  = 1 - sigmoid(è·ç¦»)
            distances = torch.norm(centers - centroid, dim=1)
            soft_mask = 1 - torch.sigmoid(distances)
            
            # LovÃ¡sz hingeæŸå¤±
            loss += lovasz_hinge(soft_mask, ground_truth_mask)
```

æ•°å­¦å½¢å¼ï¼š
$$\mathcal{L}_{\text{ins}} = \frac{1}{|\mathcal{C}|} \sum_{j=1}^{|\mathcal{C}|} \text{LovÃ¡sz}(\mathbf{F}_{\mathcal{C}_j}, \mathbf{G}_{\mathcal{C}_j})$$

### æŸå¤±ä½œç”¨èŒƒå›´

| æŸå¤± | ä½œç”¨ç±»åˆ« | è¯´æ˜ |
|------|----------|------|
| $\mathcal{L}_{\text{sem}}$ | æ‰€æœ‰ç±»åˆ« | 6ç±»è¯­ä¹‰åˆ†ç±» |
| $\mathcal{L}_{\text{ins1}}$ | Thingsç±»ï¼ˆfruit, trunkï¼‰ | æ ‡å‡†å®ä¾‹åˆ†å‰² |
| $\mathcal{L}_{\text{ins2}}$ | æ ‘æœ¨ï¼ˆtreeï¼‰ | å±‚æ¬¡å®ä¾‹åˆ†å‰² |

---

## ğŸ”„ æ•°æ®å¤„ç†æµç¨‹

### æ•°æ®åŠ è½½ï¼ˆdatasets/dataset.pyï¼‰

```python
class HAPT3DDataset(Dataset):
    def __getitem__(self, idx):
        # 1. è¯»å–PLYæ–‡ä»¶
        pcd = o3d.io.read_point_cloud(ply_path)
        
        # 2. æå–åæ ‡å’Œé¢œè‰²
        coords = np.asarray(pcd.points)
        colors = np.asarray(pcd.colors)  # å½’ä¸€åŒ–åˆ°[0,1]
        
        # 3. åŠ è½½æ ‡ç­¾
        # semantic: [N] è¯­ä¹‰æ ‡ç­¾ (0-5)
        # instance: [N] å®ä¾‹ID
        # semantic_h: [N] å±‚æ¬¡è¯­ä¹‰ (0-1)
        # instance_h: [N] å±‚æ¬¡å®ä¾‹ID
        
        # 4. ç‚¹äº‘å½’ä¸€åŒ–ï¼ˆä¸­å¿ƒåŒ–+ç¼©æ”¾ï¼‰
        coords = normalize(coords)
        
        # 5. æ•°æ®å¢å¼ºï¼ˆä»…è®­ç»ƒæ—¶ï¼‰
        if self.transform:
            coords = geometric_aug(coords, cfg)  # å‡ ä½•å¢å¼º
            colors = color_aug(colors, cfg)      # é¢œè‰²å¢å¼º
        
        return {
            'coords': coords,
            'colors': colors,
            'semantic': semantic,
            'instance': instance,
            'semantic_h': semantic_h,
            'instance_h': instance_h,
            'sensor': sensor_type
        }
```

### æ•°æ®å¢å¼ºï¼ˆdatasets/tf.pyï¼‰

```python
# å‡ ä½•å¢å¼º
def geometricaug(coords, cfg, phase='train'):
    """
    - éšæœºç¼©æ”¾: [0.8, 1.2]
    - éšæœºæ—‹è½¬: X/Yè½´Â±15Â°, Zè½´Â±180Â°
    - éšæœºå‰ªåˆ‡: Â±0.2
    - éšæœºä¸‹é‡‡æ ·: [0.6, 1.0]
    """
    
# é¢œè‰²å¢å¼º
def coloraug(colors, cfg, phase='train'):
    """
    - å¯¹æ¯”åº¦: [0.8, 1.2]
    - äº®åº¦: Â±0.2
    - è‰²è°ƒ: Â±0.15
    - é¥±å’Œåº¦: Â±0.15
    """
```

### ä½“ç´ åŒ–å¤„ç†

```python
# æ¥è‡ª models/hapt3d.py
def forward(self, data):
    # ä½“ç´ åŒ–ï¼šå°†è¿ç»­åæ ‡é‡åŒ–ä¸ºç¦»æ•£ä½“ç´ 
    voxel_resolution = 0.003  # 3mm
    quantized = torch.floor(coords / voxel_resolution).int()
    
    # åˆ›å»ºç¨€ç–å¼ é‡
    sinput = ME.SparseTensor(
        features=data['colors'],      # RGBç‰¹å¾
        coordinates=quantized,        # ä½“ç´ åæ ‡
        device=self.device
    )
    
    # ç½‘ç»œå‰å‘ä¼ æ’­
    soutput, ins1, ins2 = self.network(sinput)
```

---

## ğŸ” åå¤„ç†ä¸è¯„ä¼°

### HDBSCANèšç±»åå¤„ç†

```python
# æ¥è‡ª models/hapt3d.py çš„ post_processing()
def post_processing(self, soutput, ins1, ins2, data):
    # 1. è¯­ä¹‰é¢„æµ‹
    sem_pred = soutput.F.argmax(dim=1)
    
    # 2. è®¡ç®—é¢„æµ‹ä¸­å¿ƒ
    coords = data['coords']
    ins1_centers = coords + ins1.F  # æ ‡å‡†å®ä¾‹ä¸­å¿ƒ
    ins2_centers = coords + ins2.F  # æ ‘æœ¨å®ä¾‹ä¸­å¿ƒ
    
    # 3. HDBSCANèšç±»
    # æ ‡å‡†å®ä¾‹ï¼ˆfruit, trunkï¼‰
    for cls_id in THINGS_IDS:  # [3, 4]
        mask = (sem_pred == cls_id)
        min_pts = min_n_points_fruit if cls_id == 3 else min_n_points_trunk
        
        if mask.sum() > min_pts:
            clusterer = hdbscan.HDBSCAN(min_cluster_size=min_pts)
            clusters = clusterer.fit_predict(ins1_centers[mask])
    
    # æ ‘æœ¨å®ä¾‹
    tree_mask = (sem_pred == 3) | (sem_pred == 4)  # fruit or trunk
    clusterer = hdbscan.HDBSCAN(min_cluster_size=min_n_points_tree)
    tree_clusters = clusterer.fit_predict(ins2_centers[tree_mask])
```

### å®ä¾‹èšç±»é˜ˆå€¼ï¼ˆé…ç½®å‚æ•°ï¼‰

```yaml
# æ¥è‡ª config/config_full.yaml
val:
  min_n_points_fruit: 60    # æœå®å®ä¾‹æœ€å°ç‚¹æ•°
  min_n_points_trunk: 250   # æ ‘å¹²å®ä¾‹æœ€å°ç‚¹æ•°
  min_n_points_tree: 1000   # æ ‘æœ¨å®ä¾‹æœ€å°ç‚¹æ•°
  pq_from_epoch: 50         # ä»ç¬¬50è½®å¼€å§‹è®¡ç®—PQæŒ‡æ ‡
```

### è¯„ä¼°æŒ‡æ ‡

```python
# æ¥è‡ª utils/evaluation.py
class Metrics:
    """
    è¯„ä¼°æŒ‡æ ‡:
    - mIoU: è¯­ä¹‰åˆ†å‰²çš„å¹³å‡äº¤å¹¶æ¯”
    - PQ: æ ‡å‡†å…¨æ™¯è´¨é‡ (fruit + trunk)
    - PQ_h: å±‚æ¬¡å…¨æ™¯è´¨é‡ (tree)
    - mPQ: ç»¼åˆå…¨æ™¯è´¨é‡ = (PQ + PQ_h) / 2
    """
    
    def __init__(self, task='both', device='cuda:0'):
        self.metrics = {
            'iou': JaccardIndex(task="multiclass", num_classes=6, ignore_index=0),
            'pq': PanopticQuality(things=THINGS_IDS, stuffs=STUFF_IDS),
            'pq_h': PanopticQuality(things=[1], stuffs=[0])  # æ ‘æœ¨çº§åˆ«
        }
```

---

## ğŸš€ è®­ç»ƒä¸è¿è¡Œ

### è®­ç»ƒé…ç½®

```yaml
# config/config_full.yaml å®Œæ•´é…ç½®
experiment:
  id: "full_1"

data_path: "data/hopt3d"

network:
  tanh: True
  skip: "full"              # è®ºæ–‡æå‡ºçš„å®Œæ•´è·³è·ƒè¿æ¥
  name: "MinkUNet14A"

tasks:
  semantic_segmentation:
    n_classes: 6

train:
  ignore_idx: 0
  max_epoch: 450
  lr: 0.005
  batch_size: 1
  n_gpus: 1
  workers: 0
  voxel_resolution: 0.003   # 3mmä½“ç´ åˆ†è¾¨ç‡

transform:
  min_scalefactor: 0.8
  max_scalefactor: 1.2
  max_rotation_angle_degree_x: 15
  max_rotation_angle_degree_y: 15
  max_rotation_angle_degree_z: 180
  max_shear: 0.2
```

### è®­ç»ƒå‘½ä»¤

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®
python train.py

# ä½¿ç”¨ç‰¹å®šé…ç½®
python train.py --config config/config_full.yaml
```

### è®­ç»ƒå›è°ƒï¼ˆæ¥è‡ªtrain.pyï¼‰

```python
# å¤šæŒ‡æ ‡æ£€æŸ¥ç‚¹ä¿å­˜
callbacks = [
    ModelCheckpoint(monitor='val/miou', mode='max'),      # è¯­ä¹‰åˆ†å‰²
    ModelCheckpoint(monitor='val/mpq', mode='max'),       # ç»¼åˆå…¨æ™¯
    ModelCheckpoint(monitor='val/pq_h', mode='max'),      # å±‚æ¬¡å…¨æ™¯
    ModelCheckpoint(monitor='val/ins1_loss', mode='min'), # æ ‡å‡†å®ä¾‹æŸå¤±
    ModelCheckpoint(monitor='val/ins2_loss', mode='min')  # å±‚æ¬¡å®ä¾‹æŸå¤±
]
```

### æµ‹è¯•å‘½ä»¤

```bash
python test.py --checkpoint path/to/checkpoint.ckpt
```

---

## ğŸ“Š å®éªŒç»“æœ

### ä¸åŸºçº¿æ–¹æ³•å¯¹æ¯”ï¼ˆæµ‹è¯•é›†ï¼‰

| æ–¹æ³• | æ¶æ„ | è®­ç»ƒæ¬¡æ•° | TLS mIoU | TLS PQ | TLS PQ_T | å¹³å‡mIoU | å¹³å‡mPQ |
|------|------|---------|----------|--------|----------|----------|---------|
| MaskPLS | Transformer | 2æ¬¡ | 23.3 | 36.0 | 48.9 | 23.3 | 42.3 |
| ForestPS | MinkUNet | 2æ¬¡ | 52.0 | 49.4 | 21.5 | 50.9 | 27.5 |
| **Ours** | MinkUNet+è·³è·ƒ | **1æ¬¡** | **57.7** | **49.5** | **55.4** | **53.3** | **44.6** |

**å…³é”®å‘ç°**ï¼š
- ForestPSåœ¨æ ‡å‡†PQä¸Šè¡¨ç°å°šå¯ï¼Œä½†**æ ‘æœ¨å®ä¾‹åˆ†å‰²å‡ ä¹å®Œå…¨å¤±è´¥**ï¼ˆPQ_Tä»…21.5%ï¼‰
- æœ¬æ–‡æ–¹æ³•åœ¨**ç»¼åˆæŒ‡æ ‡mPQä¸Šæœ€ä¼˜**ï¼Œä¸”åªéœ€**å•æ¬¡è®­ç»ƒ**

### è·¨ä¼ æ„Ÿå™¨æ³›åŒ–æ€§èƒ½

| ä¼ æ„Ÿå™¨ | mIoU | PQ | PQ_T | ç‰¹ç‚¹ |
|--------|------|-----|------|------|
| TLS | 57.7 | 49.5 | 55.4 | é«˜è´¨é‡ï¼Œä¸è®­ç»ƒæ•°æ®åŒæº |
| UAV | 65.2 | 51.9 | 48.9 | èˆªæ‹è§†è§’ï¼Œä¸åŒå¹´ä»½ |
| UGV | 53.1 | 42.3 | 38.7 | æ¶ˆè´¹çº§RGB-D |
| SfM | 37.1 | 35.0 | 35.8 | ä¸åŒåœ°ç‚¹ï¼ˆè¥¿ç­ç‰™ï¼‰ |

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

### 1. å±‚æ¬¡åŒ–è·³è·ƒè¿æ¥çš„æœ‰æ•ˆæ€§
- åˆ©ç”¨ä»»åŠ¡é—´çš„**è¯­ä¹‰å±‚æ¬¡å…³ç³»**
- è¯­ä¹‰ä¿¡æ¯â†’æ ‘æœ¨ä¿¡æ¯â†’æœå®/æ ‘å¹²ä¿¡æ¯çš„**çº§è”ä¼ é€’**
- æ¶ˆèå®éªŒæ˜¾ç¤ºæ¯”æ— è·³è·ƒè¿æ¥æå‡**11.2 mPQ**

### 2. åå‘ä¼ æ’­çš„é—´æ¥å½±å“
- è¯­ä¹‰è§£ç å™¨çš„è·³è·ƒè¿æ¥**æœªæ”¹å˜**
- ä½†è¯­ä¹‰åˆ†å‰²æ€§èƒ½ä»55.8æå‡è‡³70.9 mIoU
- åŸå› ï¼šå®ä¾‹è§£ç å™¨é€šè¿‡åå‘ä¼ æ’­**é—´æ¥ä¼˜åŒ–**äº†ç¼–ç å™¨å’Œè¯­ä¹‰è§£ç å™¨

### 3. å•æ¬¡è®­ç»ƒå¤šä»»åŠ¡
- åŸºçº¿æ–¹æ³•éœ€è¦**è®­ç»ƒä¸¤æ¬¡**ï¼ˆæ ‡å‡†å®ä¾‹+æ ‘æœ¨å®ä¾‹ï¼‰
- æœ¬æ–¹æ³•**ä¸€æ¬¡è®­ç»ƒ**åŒæ—¶å®Œæˆ
- è®¡ç®—æ•ˆç‡æ›´é«˜ï¼Œä¸”ä»»åŠ¡é—´ä¿¡æ¯å…±äº«æœ‰åŠ©äºæ€§èƒ½

### 4. æ³›åŒ–èƒ½åŠ›è®¾è®¡
- è®­ç»ƒæ•°æ®ä»…ä½¿ç”¨TLSé«˜è´¨é‡ç‚¹äº‘
- æµ‹è¯•æ•°æ®åŒ…å«å¤šç§ä¼ æ„Ÿå™¨
- æ¨¡å‹å±•ç°å‡º**è‰¯å¥½çš„è·¨åŸŸæ³›åŒ–**èƒ½åŠ›

---

## ğŸ“ ä»£ç ç»“æ„é€ŸæŸ¥

```
hapt3D/
â”œâ”€â”€ train.py              # è®­ç»ƒå…¥å£ï¼Œé…ç½®Trainerå’Œå›è°ƒ
â”œâ”€â”€ test.py               # æµ‹è¯•å…¥å£
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.yaml       # é»˜è®¤é…ç½®
â”‚   â””â”€â”€ config_full.yaml  # è®ºæ–‡å®Œæ•´æ–¹æ³•é…ç½®
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ hapt3d.py         # ä¸»æ¨¡å‹ç±»ï¼ˆLightningModuleï¼‰
â”‚   â”œâ”€â”€ minkunet_full.py  # å®Œæ•´è·³è·ƒè¿æ¥ç½‘ç»œï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ minkunet*.py      # å…¶ä»–å˜ä½“ï¼ˆæ¶ˆèå®éªŒç”¨ï¼‰
â”œâ”€â”€ datasets/
â”‚   â”œâ”€â”€ dataset.py        # æ•°æ®é›†ç±»
â”‚   â”œâ”€â”€ dataloader.py     # æ•°æ®æ¨¡å—
â”‚   â””â”€â”€ tf.py             # æ•°æ®å¢å¼º
â””â”€â”€ utils/
    â”œâ”€â”€ evaluation.py     # è¯„ä¼°æŒ‡æ ‡
    â”œâ”€â”€ lovasz.py         # LovÃ¡szæŸå¤±
    â””â”€â”€ viz.py            # å¯è§†åŒ–
```

---

## ğŸ”— èµ„æºé“¾æ¥

| èµ„æº | é“¾æ¥ |
|------|------|
| ğŸ“„ è®ºæ–‡ | IROS 2025 |
| ğŸ’» ä»£ç  | https://github.com/PRBonn/hapt3D |
| ğŸ“Š æ•°æ®é›† | https://www.ipb.uni-bonn.de/data/hops/ |

---

## ğŸ“ ç»“è®º

HAPT3Dæå‡ºäº†ä¸€ä¸ªç”¨äºè‹¹æœå›­3Dç‚¹äº‘çš„**å±‚æ¬¡åŒ–å…¨æ™¯åˆ†å‰²**æ¡†æ¶ï¼š

1. **åˆ›æ–°æ¶æ„**ï¼šä¸‰è§£ç å™¨è®¾è®¡ + è§£ç å™¨é—´è·³è·ƒè¿æ¥
2. **ç»Ÿä¸€è®­ç»ƒ**ï¼šå•æ¬¡è®­ç»ƒåŒæ—¶å®Œæˆè¯­ä¹‰åˆ†å‰²ã€æ ‘æœ¨å®ä¾‹åˆ†å‰²ã€æ ‡å‡†å®ä¾‹åˆ†å‰²
3. **é«˜è´¨é‡æ•°æ®é›†**ï¼šHOPSæ•°æ®é›†å…·æœ‰å¤šä¼ æ„Ÿå™¨ã€è·¨åŸŸåç§»çš„ç‰¹ç‚¹
4. **å®ç”¨ä»·å€¼**ï¼šå¯ç”¨äºè‡ªåŠ¨åŒ–äº§é‡ä¼°è®¡ã€ç²¾å‡†å†œä¸šå¹²é¢„ã€æœºå™¨äººé‡‡æ‘˜å®šä½

**æ ¸å¿ƒåˆ›æ–°ç‚¹**ï¼šåˆ©ç”¨å†œä¸šåœºæ™¯ä¸­çš„**è‡ªç„¶å±‚æ¬¡ç»“æ„**ï¼ˆæœå›­â†’æ ‘æœ¨â†’æœå®ï¼‰ï¼Œé€šè¿‡çº§è”è·³è·ƒè¿æ¥è®©ç½‘ç»œå­¦ä¹ åˆ°æ›´æœ‰æ•ˆçš„ç‰¹å¾è¡¨ç¤ºã€‚

---

*æœ¬æ–‡æ¡£æ•´åˆäº†è®ºæ–‡å†…å®¹ä¸ä»£ç å®ç°ç»†èŠ‚ï¼Œé€‚åˆæ·±å…¥ç†è§£HAPT3Dé¡¹ç›®ã€‚*
