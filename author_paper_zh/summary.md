# 真实果园环境中跨不同传感器的3D层次化全景分割

## 作者信息
Matteo Sodano, Federico Magistri, Elias Marks, Fares Hosn, Aibek Zurbayev, Rodrigo Marcuzzi, Meher V. R. Malladi, Jens Behley, Cyrill Stachniss

所有作者均来自德国波恩大学机器人中心。Cyrill Stachniss 同时任职于英国牛津大学工程科学系以及德国拉马尔机器学习与人工智能研究所。

---

## 摘要

作物产量估计是农业中的一个重要问题，因为准确的产量估计可以支持农民在收获或精准干预方面的决策。机器人可以帮助实现这一过程的自动化。为此，它们需要能够感知周围环境，以识别目标对象，如树木和植物。

在本文中，我们提出了一种新方法，用于解决来自不同传感器的3D数据上苹果园的**层次化全景分割**问题。我们的方法能够同时提供：
- **语义分割**
- **树干和果实的实例分割**
- **树木的实例分割**（一棵树干及其果实）

这使我们能够识别相关信息，如单个植物、果实和树干，并捕获它们之间的关系，例如精确估计果园中每棵树关联的果实数量。

为了有效评估我们的层次化全景分割方法，我们提供了一个专门为此任务设计的数据集。我们的数据集在德国波恩的真实苹果园中录制，使用了多种传感器，从地面激光扫描仪到安装在不同机器人平台上的RGB-D相机。

实验表明，我们的方法在农业领域的3D全景分割方面超越了现有最先进的方法，同时还提供了完整的层次化全景分割。

- **数据集**: https://www.ipb.uni-bonn.de/data/hops/
- **代码**: https://github.com/PRBonn/hapt3D

---

## 1. 引言

### 1.1 研究背景与动机

作物产量估计是农业中的一项重要任务。准确的产量估计可以帮助农民做出管理决策，以：
- 提高作物产量
- 优化关键因素（如收获时间和施肥量）
- 实现精准干预

机器人可以自动化或支持许多这些干预措施，但要可靠和稳健地做到这一点，它们需要通过解释传感器数据来理解其周围环境。

在园艺中，分割、计数和定位果园中的果实等任务至关重要，因为它们是取代人工采摘果实所必需的，而人工采摘是一个极其劳动密集型的过程。

### 1.2 研究现状

最近，许多方法针对农业中的感知任务。语义分割和全景分割尤为常见。这也推动了农业感知任务数据集的发布。然而，**真实农业环境的3D数据集并不常见**。

### 1.3 主要贡献

本文的主要贡献是双重的：

1. **方法贡献**：我们提出了一种基于卷积神经网络(CNN)的层次化全景分割方法，该方法能够同时处理多个实例分割任务，同时通过新颖的跳跃连接方案利用它们之间的底层层次关系。

2. **数据集贡献**：我们引入了一个名为**HOPS**（Hierarchical Orchard Panoptic Segmentation，层次化果园全景分割）的真实苹果园3D点云数据集，使用各种传感器录制：
   - 地面激光扫描仪(TLS)
   - RGB-D相机
   - RGB相机配合后续的光束法平差

我们在两年内跨多个作物行的不同生长阶段录制了苹果园的数据，并标记了生成的点云以获得：
- 语义分割
- 树木实例分割
- 果实和树干实例分割

### 1.4 核心声明

我们的实验表明：
1. 我们的方法可以在使用不同传感器获取的真实世界3D数据上联合执行语义分割、树木实例分割和标准实例分割
2. 我们的跳跃连接方案使CNN能够利用各个分割任务之间的底层层次关系，从而获得更好的分割性能

---

## 2. 相关工作

### 2.1 农业中的语义场景解释

语义场景解释通常是实现农业机器人自动化所必需的，因为它识别场景中与任务相关的对象，从而实现监测和干预等应用。

### 2.2 3D点云的全景分割

**全景分割**统一了语义分割和实例分割，同时提供：
- **背景类（"stuff"）**的语义
- **前景对象（"things"）**的对象级实例

虽然图像通常用于农业领域的全景分割，但由RGB-D相机、LiDAR或摄影测量运动恢复结构方法生成的3D点云由于能够提取精确几何信息而受到越来越多的研究关注。

对于植物表型分析，我们可以利用植物的层次结构，将其分解为单独的部分：
- 植物
- 叶子
- 更细粒度的叶子结构

### 2.3 现有数据集

| 数据集 | 描述 |
|--------|------|
| BUP20 | 温室中甜椒实例分割的RGB-D数据集 |
| BonnBeetClouds | 甜菜植物的植物和叶片实例标注 |
| Crops3D | 不同作物品种的器官级标注 |

与现有数据集相比，**HOPS**的特点：
- 提供特定领域的果园农业数据集
- 使用不同传感器录制
- 标注了植物和果实实例
- 提供高分辨率TLS点云和SfM点云数据

---

## 3. 我们的层次化全景分割方法

### 3.1 任务定义

我们提出了一种**层次化全景分割**方法，即同时执行：
- **语义分割**
- **多个实例分割任务**（具有底层层次关系）

网络是**编码器-解码器架构**，包含三个解码器：

| 解码器 | 任务 | 描述 |
|--------|------|------|
| 解码器1 | 语义分割 | 对每个点进行语义类别分类 |
| 解码器2 | 树木实例分割 | 一棵树 = 一个树干 + 属于它的所有果实 |
| 解码器3 | 标准实例分割 | 单独分割每个树干和果实 |

### 3.2 网络架构

我们使用基于**MinkUNet**的神经网络：
- 受UNet设计启发
- 编码器和解码器通过跳跃连接连接
- 使用**稀疏3D卷积**处理输入数据
- 具体使用**MinkUNet14A**模型（轻量级，每层更少特征通道）

### 3.3 损失函数

#### 语义分割损失
使用标准加权交叉熵损失：

$$\mathcal{L}_{\mathrm{sem}} = - \frac{1}{|\mathcal{S}|} \sum_{\mathbf{p} \in \mathcal{S}} \omega_k \, \mathbf{t}_{p}^\top \, \log(\sigma(\mathbf{f}_p))$$

其中：
- $|\mathcal{S}|$ 是点云中的点数
- $\mathbf{p}$ 表示单个点
- $\omega_k$ 是类别权重（通过逆频率计算）
- $\sigma(\cdot)$ 表示softmax操作

#### 实例分割损失
使用适配到3D的**Lovász Hinge损失**：

$$\mathcal{L}_{\mathrm{tree}} = \dfrac{1}{|\mathcal{C}|} \sum_{j=1}^{|\mathcal{C}|} \mathrm{Lovász} (\mathbf{F}_{\mathcal{C}_j}, \, \mathbf{G}_{\mathcal{C}_j})$$

每个点预测一个偏移向量 $\mathbf{o}_p \in \mathbb{R}^3$，使得 $\mathbf{e}_p = \mathbf{p} + \mathbf{o}_p$。

#### 总损失
$$\mathcal{L} = w_1 \, \mathcal{L}_{\mathrm{sem}} + w_2 \, \mathcal{L}_{\mathrm{tree}} + w_3 \, \mathcal{L}_{\mathrm{ins}}$$

### 3.4 层次化跳跃连接（核心创新）

跳跃连接对于确保**特征重用**和解决CNN的**梯度退化问题**至关重要。

我们提出的创新跳跃连接方案：

| 分割任务 | 跳跃连接来源 |
|----------|--------------|
| 语义分割 | 编码器 → 语义解码器 |
| 树木实例分割 | 编码器 + 语义解码器 → 树木实例解码器 |
| 实例分割 | 编码器 + 树木实例解码器 → 实例解码器 |

**信息流示意**：
```
编码器 → 提供基本高分辨率空间引导
    ↓
语义解码器 → 添加语义标签
    ↓
树木实例解码器 → 识别单个树木作为标志
    ↓
实例解码器 → 添加更细的区分（果实和树干）
```

### 3.5 后处理

1. 实例分割解码器为每个点预测偏移向量
2. 使用**HDBSCAN**对偏移进行聚类以获得实例掩码
3. 使用语义预测强制实例之间的一致性

---

## 4. HOPS数据集

### 4.1 数据来源

数据集在德国波恩附近的**Campus Klein-Altendorf**收集，使用四种不同传感器/来源：

| 传感器 | 描述 | 用途 |
|--------|------|------|
| **TLS** | 地面激光扫描仪，放置在果园行内多个位置 | 训练集、验证集、测试集 |
| **UAV** | 无人机配备PhaseOne iXM-100相机，45°/90°/135°角度，约20m高度 | 测试集 |
| **UGV** | 地面机器人配备RealSense d435i | 测试集 |
| **Fuji-SfM** | Canon EOS 60D DSLR相机（西班牙Agramunt） | 测试集 |

### 4.2 语义类别定义

| 类别 | 类型 | 描述 |
|------|------|------|
| 地面 (Ground) | Stuff | 背景类 |
| 树干 (Trunk) | Things | 前景对象 |
| 树冠 (Canopy) | Stuff | 背景类 |
| 苹果 (Apple) | Things | 前景对象 |
| 杆 (Pole) | Stuff | 背景类 |

**特殊类别**：**树木 (Tree)** = 一个树干 + 属于它的所有苹果

### 4.3 数据集统计

| 指标 | 训练集(TLS) | 验证集(TLS) | 测试集-UGV | 测试集-UAV | 测试集-SfM | 测试集-TLS |
|------|-------------|-------------|------------|------------|------------|------------|
| 样本数 | 90 | 18 | 12 | 22 | 6 | 27 |
| 平均点数 | 0.8M | 1M | 0.6M | 1.5M | 1.8M | 1M |
| 果实数 | 90.2 | 99.2 | 71.8 | 99.1 | 232.3 | 39.9 |
| 树干数 | 3.1 | 3.2 | 2.9 | 1.9 | 2.7 | 2.9 |
| 每棵树果实数 | 19.2 | 19.3 | 17.8 | 31.7 | 62.1 | 9.8 |

### 4.4 标注流程

1. 将聚合点云分割成单独瓦片（平均每个100万点）
2. 使用segments.ai在线工具分三阶段手动标记
3. 第一标注者标记语义和两级实例分割
4. 第二标注者验证标签质量

**工作量**：
- 标注：平均每瓦片4小时，总计525小时
- 验证：175小时

### 4.5 设计特点

HOPS专门设计使**训练集和测试集之间存在显著的域偏移**：
- 训练集：仅包含TLS高质量点云
- 测试集：包含各种传感器的数据

这更接近真实世界的部署场景，推动研究者构建具有良好泛化性能的模型。

---

## 5. 实验评估

### 5.1 评估指标

| 指标 | 描述 | 用于任务 |
|------|------|----------|
| **mIoU** | 平均交并比 | 语义分割 |
| **PQ** | 平均全景质量 | 标准实例分割 |
| **PQ_T** | 单类全景质量（树木类） | 树木实例分割 |
| **mPQ** | 整体平均全景质量 = (PQ + PQ_T) / 2 | 综合评估 |

### 5.2 训练细节

| 参数 | 值 |
|------|-----|
| 优化器 | AdamW |
| 权重衰减 | 0.99 |
| 初始学习率 | 5×10⁻³ |
| 损失权重 | w₁ = w₂ = w₃ = 1 |
| 训练轮数 | 500 epochs |
| 批量大小 | 1 |
| 体素下采样 | 3mm |

**数据增强**：
- 缩放
- 绕所有轴旋转
- 剪切
- 颜色抖动
- 弹性变形

### 5.3 基线对比

| 方法 | 描述 |
|------|------|
| **MaskPLS** | 基于transformer，将Mask2Former扩展到3D点云 |
| **ForestPS** | 基于MinkUNet的CNN，最初为森林树木分割设计 |

注意：基线一次只能处理一个实例分割任务，需要训练两次。我们的方法**单次训练**解决两个任务。

### 5.4 测试集结果

| 方法 | TLS mIoU | TLS PQ | TLS PQ_T | UAV mIoU | UAV PQ | UAV PQ_T | 平均mIoU | 平均mPQ |
|------|----------|--------|----------|----------|--------|----------|----------|---------|
| MaskPLS | 23.3 | 36.0 | 48.9 | 20.0 | 36.0 | 48.4 | 23.3 | 42.3 |
| ForestPS | 52.0 | 49.4 | 21.5 | 64.3 | **62.8** | 2.1 | 50.9 | 27.5 |
| **Ours** | **57.7** | **49.5** | **55.4** | **65.2** | 51.9 | **48.9** | **53.3** | **44.6** |

**关键发现**：
- ForestPS在PQ上表现较好，但在树木实例分割(PQ_T)上完全失败（在大多数分割上低于3%）
- 我们的方法在mPQ（综合评估）上最优

### 5.5 消融研究（验证集）

| 方案 | 跳跃连接 | mIoU | PQ | PQ_T | mPQ |
|------|----------|------|-----|------|------|
| A | 无 | 55.8 | 42.8 | 47.7 | 45.3 |
| B | 仅解码器到解码器 | 64.4 | 53.4 | 51.3 | 52.4 |
| C | 仅编码器到解码器 | 69.8 | 58.8 | 50.9 | 54.9 |
| **D** | **编码器+解码器（ours）** | **70.9** | **60.8** | **52.1** | **56.5** |

**分析**：
- **方案A**：无跳跃连接导致性能不佳，因为解码器缺乏高级信息
- **方案B**：仅解码器跳跃连接不够有效
- **方案C**：标准UNet式连接比仅解码器更有效
- **方案D**：我们的方法最优，同时受益于编码器特征和任务层次结构

有趣的是，我们的方法在语义分割上也提供了更好的结果，尽管语义解码器的跳跃连接方案没有变化。这表明实例解码器的信息通过反向传播间接影响编码器和语义解码器对语义分割性能有益。

---

## 6. 结论

本文的主要贡献：

### 6.1 方法贡献
- 提出了一种新的点云数据**层次化3D全景分割**方法
- 通过新颖的**跳跃连接方案**利用不同分割任务之间的底层层次结构
- 能够同时产生：
  - 语义分割
  - 树木实例分割（树干+果实）
  - 标准实例分割

### 6.2 数据集贡献
- 引入了**HOPS**数据集
- 来自真实苹果园
- 两年内使用不同传感器录制
- 标注用于层次化全景分割
- 具有挑战性的域偏移设计

### 6.3 实验验证
- 取得了最先进的结果
- 超越或可与现有任务特定基线相媲美
- 单次训练解决多个实例分割任务

---

## 资源链接

- **数据集下载**: https://www.ipb.uni-bonn.de/data/hops/
- **代码仓库**: https://github.com/PRBonn/hapt3D
